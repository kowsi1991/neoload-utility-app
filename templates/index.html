<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NeoLoad Forge</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
  <h1>NeoLoad Forge</h1>
  <p>Select a utility:</p>

  <select id="tool-selector">
    <option value="curl-commands">1. CURL commands → OpenAPI</option>
    <option value="curl-file">2. CURL file → OpenAPI</option>
    <option value="postman-json">3. Postman JSON → NeoLoad Script</option>
    <option value="postman-openapi">4. Postman JSON → OpenAPI</option>
  </select>

  <div id="curl-commands-section" class="form-section active">
    <h2>CURL commands → OpenAPI</h2>
    <textarea id="curl-commands-input" placeholder="Paste a cURL command"></textarea>
    <button id="validate-button">Validate</button>
    <button id="add-request-button" style="display:none;">Add Request</button>
    <p id="validation-message" class="message"></p>
    <h3>Validated Requests (<span id="request-count">0</span>)</h3>
    <ul id="requests-list"></ul>
    <button id="generate-button" style="display:none;">Generate OpenAPI JSON</button>
  </div>

  <div id="curl-file-section" class="form-section">
    <h2>CURL file → OpenAPI</h2>
    <input type="file" id="curl-file-input" accept=".txt,.log">
    <button id="upload-button">Upload & Generate</button>
  </div>

  <div id="postman-json-section" class="form-section">
    <h2>Postman JSON → NeoLoad Script</h2>
    <input type="file" id="postman-file-input" accept=".json">
    <button id="postman-button">Convert</button>
  </div>

  <div id="postman-openapi-section" class="form-section">
    <h2>Postman JSON → OpenAPI</h2>
    <input type="file" id="postman-openapi-input" accept=".json">
    <button id="postman-openapi-button">Upload & Generate</button>
  </div>

  <div class="result-box">
    <h3>Result</h3>
    <pre id="output-box"></pre>
    <button id="download-button" style="display:none;">Download JSON</button>
  </div>
</div>

<script>
        document.addEventListener('DOMContentLoaded', function() {
            const toolSelector = document.getElementById('tool-selector');
            const sections = document.querySelectorAll('.form-section');
            const outputBox = document.getElementById('output-box');
            
            const curlInput = document.getElementById('curl-commands-input');
            const validateButton = document.getElementById('validate-button');
            const addRequestButton = document.getElementById('add-request-button');
            const generateButton = document.getElementById('generate-button');
            const downloadButton = document.getElementById('download-button');
            const validationMessage = document.getElementById('validation-message');
            const requestsList = document.getElementById('requests-list');
            const requestCount = document.getElementById('request-count');
            
            let validatedRequests = [];

            function showSection(id) {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(id).classList.add('active');
                
                outputBox.textContent = '';
                downloadButton.style.display = 'none';

                if (id === 'curl-commands-section') {
                    validatedRequests = [];
                    updateRequestsList();
                }
            }

            function updateRequestsList() {
                requestsList.innerHTML = '';
                validatedRequests.forEach((req, index) => {
                    const li = document.createElement('li');
                    li.textContent = `Request ${index + 1}`;
                    requestsList.appendChild(li);
                });
                requestCount.textContent = validatedRequests.length;
                if (validatedRequests.length > 0) {
                    generateButton.style.display = 'block';
                } else {
                    generateButton.style.display = 'none';
                }
            }

            toolSelector.addEventListener('change', (event) => {
                const selectedTool = event.target.value;
                if (selectedTool === 'curl-commands') {
                    showSection('curl-commands-section');
                } else if (selectedTool === 'curl-file') {
                    showSection('curl-file-section');
                } else if (selectedTool === 'postman-json') {
                    showSection('postman-json-section');
                } else if (selectedTool === 'postman-openapi') {
                    showSection('postman-openapi-section');
                }
            });

            // Validate cURL command
            validateButton.addEventListener('click', () => {
                const command = curlInput.value.trim();
                if (!command) {
                    validationMessage.textContent = "Please enter a cURL command.";
                    validationMessage.style.color = 'red';
                    addRequestButton.style.display = 'none';
                    return;
                }

                fetch('/validate_curl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Unknown validation error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    validationMessage.textContent = "✅ Valid!";
                    validationMessage.style.color = 'green';
                    addRequestButton.style.display = 'inline-block';
                })
                .catch(err => {
                    validationMessage.textContent = `❌ Error: ${err.message}`;
                    validationMessage.style.color = 'red';
                    addRequestButton.style.display = 'none';
                });
            });

            // Add validated request
            addRequestButton.addEventListener('click', () => {
                const command = curlInput.value.trim();
                if (command) {
                    validatedRequests.push(command);
                    updateRequestsList();
                    curlInput.value = '';
                    validationMessage.textContent = '';
                    addRequestButton.style.display = 'none';
                }
            });

            // Generate OpenAPI JSON from commands
            generateButton.addEventListener('click', () => {
                if (validatedRequests.length === 0) {
                    outputBox.textContent = "Please add at least one validated request.";
                    return;
                }
                fetch('/generate_openapi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requests: validatedRequests })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Unknown server error'); });
                    }
                    return response.json();
                })
                .then(json => {
                    outputBox.textContent = JSON.stringify(json, null, 2);
                    downloadButton.style.display = 'inline-block';
                })
                .catch(err => {
                    console.error('Error:', err);
                    outputBox.textContent = `Error: ${err.message}`;
                    downloadButton.style.display = 'none';
                });
            });

            // Upload CURL file and generate OpenAPI JSON
            document.getElementById('upload-button').addEventListener('click', () => {
                const fileInput = document.getElementById('curl-file-input');
                const file = fileInput.files[0];
                if (!file) {
                    outputBox.textContent = "Please select a file.";
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);
                fetch('/upload_curl_file', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Unknown server error'); });
                    }
                    return response.json();
                })
                .then(json => {
                    outputBox.textContent = JSON.stringify(json, null, 2);
                    downloadButton.style.display = 'inline-block';
                })
                .catch(err => {
                    console.error('Error:', err);
                    outputBox.textContent = `Error: ${err.message}`;
                    downloadButton.style.display = 'none';
                });
            });

            // Download OpenAPI JSON
            downloadButton.addEventListener('click', () => {
                const openapiJson = outputBox.textContent;
                if (openapiJson) {
                    const blob = new Blob([openapiJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'openapi-spec.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            });

            // Postman JSON conversion
            document.getElementById('postman-button').addEventListener('click', () => {
                const fileInput = document.getElementById('postman-file-input');
                const file = fileInput.files[0];
                if (!file) {
                    outputBox.textContent = "Please select a Postman JSON file.";
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const postmanData = JSON.parse(event.target.result);
                        fetch('/convert_postman_json', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ collection: postmanData })
                        })
                        .then(response => response.json())
                        .then(json => outputBox.textContent = JSON.stringify(json, null, 2))
                        .catch(err => outputBox.textContent = `Error: ${err}`);
                    } catch (e) {
                        outputBox.textContent = "Error: Invalid JSON file. Please upload a valid Postman collection.";
                    }
                };
                reader.readAsText(file);
            });

            // New: Postman JSON to OpenAPI conversion
            document.getElementById('postman-openapi-button').addEventListener('click', () => {
                const fileInput = document.getElementById('postman-openapi-input');
                const file = fileInput.files[0];
                if (!file) {
                    outputBox.textContent = "Please select a Postman JSON file.";
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const postmanData = JSON.parse(event.target.result);
                        fetch('/postman_to_openapi', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ collection: postmanData })
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.error || 'Unknown server error'); });
                            }
                            return response.json();
                        })
                        .then(json => {
                            outputBox.textContent = JSON.stringify(json, null, 2);
                            downloadButton.style.display = 'inline-block';
                        })
                        .catch(err => {
                            console.error('Error:', err);
                            outputBox.textContent = `Error: ${err.message}`;
                            downloadButton.style.display = 'none';
                        });
                    } catch (e) {
                        outputBox.textContent = "Error: Invalid JSON file. Please upload a valid Postman collection.";
                    }
                };
                reader.readAsText(file);
            });

            showSection('curl-commands-section');
        });
    </script>
</body>
</html>